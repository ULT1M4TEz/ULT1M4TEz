<!DOCTYPE html>
<html lang="th">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Order Management Pro</title>
  
  <!-- Fonts: Prompt -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Icons: Material Symbols Rounded -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <style>
    :root {
      /* Brand Colors */
      --primary: #4F46E5; /* Indigo */
      --primary-light: #E0E7FF;
      --primary-hover: #4338CA;
      
      /* Accents */
      --success: #10B981;
      --success-bg: #D1FAE5;
      --danger: #EF4444;
      --danger-bg: #FEE2E2;
      --warning: #F59E0B;
      --warning-bg: #FEF3C7;

      /* Neutrals */
      --bg-body: #F3F4F6;
      --bg-surface: #FFFFFF;
      --text-main: #111827;
      --text-sub: #6B7280;
      --border: #E5E7EB;

      /* UI Metrics */
      --sidebar-width: 260px;
      --header-height: 64px;
      --radius: 16px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      
      --font-main: 'Prompt', sans-serif;
    }

    /* --- Reset & Base --- */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-main); font-size: 14px; line-height: 1.5; overflow: hidden; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }

    /* --- Layout Structure --- */
    .app-layout { display: flex; height: 100vh; width: 100vw; background: var(--bg-body); }

    /* Sidebar (Desktop) */
    .sidebar {
      width: var(--sidebar-width); background: var(--bg-surface); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; padding: 20px; z-index: 20;
    }
    .logo-area {
      display: flex; align-items: center; gap: 12px; padding: 10px 10px 30px 10px;
      font-size: 20px; font-weight: 700; color: var(--primary);
    }
    .nav-menu { display: flex; flex-direction: column; gap: 8px; flex: 1; }
    
    .nav-btn {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px;
      color: var(--text-sub); font-weight: 500; cursor: pointer; transition: all 0.2s;
      border: none; background: transparent; font-family: inherit; font-size: 15px; text-align: left;
    }
    .nav-btn:hover { background: var(--bg-body); color: var(--text-main); }
    .nav-btn.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
    .nav-btn .icon { font-size: 24px; }

    /* Mobile Bottom Nav */
    .bottom-nav { display: none; }

    /* Main Content Area */
    .main-content {
      flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative;
    }
    .page-header {
      height: var(--header-height); background: rgba(243, 244, 246, 0.9); backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: space-between; padding: 0 30px;
      position: sticky; top: 0; z-index: 10;
    }
    .page-title { font-size: 18px; font-weight: 600; color: var(--text-main); }
    
    .scroll-area {
      flex: 1; overflow-y: auto; padding: 20px 30px 20px 30px;
    }

    /* Sticky Footer */
    .page-footer {
      background: var(--bg-surface); border-top: 1px solid var(--border); padding: 12px 20px;
      z-index: 10; flex-shrink: 0; display: flex; justify-content: center; align-items: center;
    }

    /* --- Responsive (Mobile) --- */
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .app-layout { flex-direction: column; }
      .page-header { padding: 0 20px; height: 56px; background: var(--bg-surface); border-bottom: 1px solid var(--border); }
      
      .scroll-area { padding: 16px 16px 100px 16px; }
      .page-footer { padding-bottom: 80px; }

      .bottom-nav {
        display: flex; position: fixed; bottom: 0; left: 0; right: 0;
        background: var(--bg-surface); border-top: 1px solid var(--border);
        padding: 8px 16px; padding-bottom: max(8px, env(safe-area-inset-bottom));
        justify-content: space-around; z-index: 50; box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.05);
      }
      .b-nav-item {
        display: flex; flex-direction: column; align-items: center; gap: 4px;
        color: var(--text-sub); background: none; border: none;
        font-family: inherit; font-size: 11px; font-weight: 500;
        padding: 8px 12px; border-radius: 8px; width: 80px;
      }
      .b-nav-item.active { color: var(--primary); background: var(--primary-light); }
      .b-nav-item .material-symbols-rounded { font-size: 24px; }

      .autocomplete-list {
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15); border: 1px solid var(--primary-light);
      }
      .ac-item { padding: 14px 16px; font-size: 15px; border-bottom: 1px solid #F9FAFB; }
      
      /* Mobile Inputs */
      .form-control { height: 42px; font-size: 14px; }
      .btn-icon-soft { width: 42px; height: 42px; }
      .product-item { padding: 8px; gap: 8px; }
    }

    /* --- Common Components --- */
    .card { background: var(--bg-surface); border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 24px; box-shadow: var(--shadow-sm); overflow: visible; }
    .card-body { padding: 24px; }
    .card-header-simple { 
      padding: 20px 24px; border-bottom: 1px solid var(--border); 
      display: flex; justify-content: space-between; align-items: center; 
    }
    .card-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }

    /* Form Styles */
    .section-title { font-size: 14px; color: var(--primary); font-weight: 600; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-grid { display: grid; gap: 20px; }
    .grid-2 { grid-template-columns: 1fr 1fr; }
    .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
    @media (max-width: 600px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }

    .form-group { margin-bottom: 0; }
    .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-main); margin-bottom: 8px; }
    .form-label span { color: var(--danger); }
    
    .form-control {
      width: 100%; height: 44px; padding: 0 16px;
      border: 1px solid var(--border); border-radius: 10px;
      font-family: inherit; font-size: 14px; background: #FAFAFA;
      transition: all 0.2s; outline: none; appearance: none; display: flex; align-items: center;
    }
    .form-control:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
    .form-control:disabled { background: #E5E7EB; color: #9CA3AF; cursor: not-allowed; }
    
    .form-control.error { border-color: var(--danger); background-color: var(--danger-bg); }
    .error-msg { font-size: 12px; color: var(--danger); margin-top: 6px; display: none; }
    .form-control.error + .error-msg { display: block; }

    /* Phone Counter */
    .phone-wrapper { position: relative; }
    .phone-counter { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 12px; color: #9CA3AF; transition: 0.2s; pointer-events: none; }
    .phone-counter.valid { color: var(--success); }
    .phone-counter.invalid { color: var(--danger); }

    /* Product List */
    .product-list-box { background: #F9FAFB; border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .product-item {
      display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-start;
      background: white; padding: 10px; border-radius: 10px; border: 1px solid var(--border);
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    .btn-icon-soft {
      width: 44px; height: 44px; border-radius: 10px; border: none;
      background: var(--danger-bg); color: var(--danger);
      display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
    }
    
    .search-select-wrapper { position: relative; }
    
    /* NEW: Clear Button */
    .input-clear-btn {
      position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
      color: #9CA3AF; cursor: pointer; font-size: 18px; display: none; z-index: 5;
    }
    .input-clear-btn:hover { color: var(--danger); }
    
    .autocomplete-list {
      position: absolute; top: 100%; left: 0; right: 0;
      background: white; border: 1px solid var(--border);
      border-radius: 10px; max-height: 220px; overflow-y: auto;
      z-index: 100; margin-top: 6px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); display: none;
    }
    .autocomplete-list.show { display: block; }
    .ac-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6; font-size: 14px; }
    .ac-item:hover { background: var(--primary-light); color: var(--primary); }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 12px 24px; border-radius: 10px; font-weight: 600;
      cursor: pointer; transition: 0.2s; border: none; font-family: inherit; font-size: 14px;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-secondary:hover { background: #F9FAFB; }
    .btn-warning { background: var(--warning); color: #fff; }
    .btn-add {
      background: white; border: 1px dashed var(--primary); color: var(--primary);
      width: 100%; padding: 12px; margin-top: 8px; border-radius: 10px;
    }
    .btn-add:hover { background: var(--primary-light); border-style: solid; }
    .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 8px; }

    /* --- Dashboard & List --- */
    .filter-bar {
      background: white; padding: 16px; border-radius: 12px; border: 1px solid var(--border);
      display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 24px; align-items: center;
    }
    .filter-input {
      background: #F9FAFB; border: 1px solid var(--border); border-radius: 8px;
      padding: 8px 12px; font-family: inherit; font-size: 13px; outline: none;
    }
    .search-wrapper { flex: 1; min-width: 200px; position: relative; }
    .search-wrapper input { width: 100%; padding-left: 36px; }
    .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 18px; }
    
    /* Summary Widgets */
    .summary-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px; margin-bottom: 24px;
    }
    .stat-card {
      background: white; border-radius: 12px; padding: 20px; border: 1px solid var(--border);
      display: flex; flex-direction: column; align-items: flex-start; position: relative; overflow: hidden;
    }
    .stat-card::after {
      content: ''; position: absolute; right: -10px; top: -10px; width: 80px; height: 80px; border-radius: 50%;
      background: var(--primary-light); opacity: 0.5; z-index: 0;
    }
    .stat-val { font-size: 32px; font-weight: 700; color: var(--text-main); line-height: 1; z-index: 1; }
    .stat-label { font-size: 13px; color: var(--text-sub); margin-top: 4px; z-index: 1; }
    
    .stat-avg { 
      width: 100%; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #E5E7EB; 
      display: flex; flex-direction: column; gap: 4px; font-size: 12px; color: var(--text-sub); 
      z-index: 1; background: none; border-radius: 0; 
    }
    .stat-row { display: flex; justify-content: space-between; align-items: center; }
    .stat-row b { color: var(--text-main); font-weight: 600; }
    .stat-icon { margin-bottom: 12px; color: var(--primary); background: var(--primary-light); padding: 8px; border-radius: 8px; }

    /* Advanced Summary (Products) */
    .product-summary-card {
      background: white; border-radius: 12px; padding: 20px; border: 1px solid var(--border); margin-bottom: 24px;
    }
    .tag-cloud { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .tag-item {
      font-size: 12px; background: #F3F4F6; color: var(--text-main);
      padding: 6px 12px; border-radius: 20px; border: 1px solid #E5E7EB;
    }
    .tag-item b { color: var(--primary); margin-left: 4px; }
    .tag-item small { color: #6B7280; font-size: 10px; margin-left: 4px; }

    /* Order List */
    .order-item {
      background: white; border: 1px solid var(--border); border-radius: 12px;
      padding: 20px; margin-bottom: 16px; transition: all 0.2s; display: flex; flex-direction: column; gap: 12px;
    }
    .order-item:hover { border-color: var(--primary); box-shadow: var(--shadow); transform: translateY(-2px); }
    
    .oi-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed var(--border); padding-bottom: 12px; }
    .oi-id { font-weight: 700; color: var(--primary); font-size: 16px; display: flex; align-items: center; gap: 6px; }
    .oi-meta { font-size: 12px; color: var(--text-sub); background: #F3F4F6; padding: 4px 8px; border-radius: 6px; }
    
    .oi-body { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; font-size: 13px; }
    .oi-field label { display: block; font-size: 11px; color: var(--text-sub); margin-bottom: 2px; }
    .oi-field span { font-weight: 500; color: var(--text-main); }
    
    .oi-products { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
    .prod-badge { font-size: 11px; background: var(--primary-light); color: var(--primary); padding: 4px 10px; border-radius: 20px; font-weight: 600; border: 1px solid rgba(79, 70, 229, 0.1); }
    
    .oi-actions { display: flex; gap: 8px; justify-content: flex-end; padding-top: 12px; border-top: 1px dashed var(--border); }

    /* Pagination */
    .pagination { display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 0; }
    .page-btn {
      min-width: 32px; height: 32px; padding: 0 6px; border-radius: 8px; border: 1px solid var(--border);
      background: white; color: var(--text-main); font-size: 13px; font-weight: 500; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s;
    }
    .page-btn:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); }
    .page-btn.active, .page-btn.active:hover { background: var(--primary); color: white; border-color: var(--primary); }
    .page-btn:disabled { opacity: 0.5; cursor: default; }
    .page-dots { padding: 0 4px; color: var(--text-sub); display:flex; align-items:center; }

    /* Transitions */
    .view-section { display: none; animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); width: 100%; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Utils */
    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #f8f8f8 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; height: 100px; }
    
    /* Modal & Toast */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 900; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
    .modal-backdrop.show { display: flex; opacity: 1; }
    .modal { background: white; padding: 32px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); transform: scale(0.95); transition: 0.2s; }
    .modal-backdrop.show .modal { transform: scale(1); }
    
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 20px); background: #1F2937; color: white; padding: 12px 24px; border-radius: 50px; display: flex; align-items: center; gap: 12px; opacity: 0; visibility: hidden; transition: all 0.3s; z-index: 1000; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); font-weight: 500; }
    .toast.show { opacity: 1; visibility: visible; transform: translate(-50%, 0); }
  </style>
</head>
<body>

  <div class="app-layout">
    
    <!-- Desktop Sidebar -->
    <aside class="sidebar">
      <div class="logo-area">
        <span class="material-symbols-rounded" style="font-size:32px;">inventory_2</span>
        <span>Order Pro</span>
      </div>
      
      <nav class="nav-menu">
        <button class="nav-btn" id="menu-form" onclick="App.nav('form')">
          <span class="material-symbols-rounded icon">add_circle</span>
          <span>บันทึกออเดอร์</span>
        </button>
        <button class="nav-btn active" id="menu-list" onclick="App.nav('list')">
          <span class="material-symbols-rounded icon">dashboard</span>
          <span>รายการออเดอร์</span>
        </button>
      </nav>
      
      <div style="margin-top:auto; font-size:12px; color:#9CA3AF; text-align:center;">
        v2.0.0 Dashboard Edition
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="page-header">
        <div class="page-title" id="page-title">รายการออเดอร์</div>
        <div style="display:flex; align-items:center; gap:8px;">
           <div style="width:36px; height:36px; background:#E0E7FF; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#4F46E5; font-weight:700;">A</div>
        </div>
      </header>

      <div class="scroll-area">
        
        <!-- View: Form -->
        <section id="view-form" class="view-section">
          <div class="card">
            <div class="card-header-simple">
               <div class="card-title">
                  <span class="material-symbols-rounded" style="color:var(--primary)">edit_note</span>
                  <span id="form-heading">ข้อมูลออเดอร์</span>
               </div>
            </div>
            
            <div class="card-body">
              <div class="form-grid">
                
                <!-- Section 1 -->
                <div>
                   <div class="section-title">ข้อมูลพื้นฐาน</div>
                   <div class="form-grid grid-3">
                      <div class="form-group">
                        <label class="form-label">วันที่ <span>*</span></label>
                        <input type="date" id="inp-date" class="form-control">
                      </div>
                      <div class="form-group">
                        <label class="form-label">เลขที่สั่งซื้อ <span>*</span></label>
                        <input type="text" id="inp-orderno" class="form-control" placeholder="เช่น 2401-001">
                        <div class="error-msg">กรุณาระบุเลขที่สั่งซื้อ</div>
                      </div>
                      <div class="form-group">
                        <label class="form-label">ขนส่ง</label>
                        <div class="select-wrapper">
                          <select id="inp-courier" class="form-control">
                            <option value="">เลือกขนส่ง...</option>
                          </select>
                        </div>
                      </div>
                   </div>
                </div>

                <hr style="border:none; border-top:1px solid #E5E7EB;">

                <!-- Section 2 -->
                <div>
                  <div class="section-title">รายละเอียด</div>
                  <div class="form-grid grid-2">
                    <div class="form-group">
                      <label class="form-label">ชุดที่</label>
                      <input type="text" id="inp-set" class="form-control" placeholder="ระบุชื่อชุด">
                    </div>
                    <div class="form-group">
                      <label class="form-label">ใบที่</label>
                      <input type="number" id="inp-page" class="form-control" placeholder="1" min="1" onchange="if(this.value && this.value < 1) this.value = 1">
                    </div>
                  </div>
                  
                  <div class="form-grid grid-2" style="margin-top:20px;">
                    <div class="form-group">
                      <label class="form-label">ชื่อผู้รับ</label>
                      <input type="text" id="inp-name" class="form-control" placeholder="ชื่อ-นามสกุล">
                    </div>
                    <div class="form-group">
                      <label class="form-label">เบอร์โทรศัพท์</label>
                      <div class="phone-wrapper">
                        <input type="tel" id="inp-phone" class="form-control" placeholder="0xxxxxxxxx" maxlength="15">
                        <span id="phone-counter" class="phone-counter">0/10</span>
                      </div>
                      <div class="error-msg" id="msg-phone">เบอร์โทรศัพท์ไม่ถูกต้อง</div>
                    </div>
                  </div>
                  <div class="form-group" style="margin-top:20px;">
                      <label class="form-label">ที่อยู่จัดส่ง</label>
                      <input type="text" id="inp-address" class="form-control" placeholder="ที่อยู่ครบถ้วน">
                  </div>
                </div>

                <hr style="border:none; border-top:1px solid #E5E7EB;">

                <!-- Section 3 -->
                <div>
                   <div class="section-title">รายการสินค้า</div>
                   <div class="product-list-box">
                      <div id="product-container"></div>
                      <button type="button" class="btn btn-add" onclick="Form.addProductRow()">
                        <span class="material-symbols-rounded">add</span> เพิ่มรายการสินค้า
                      </button>
                   </div>
                </div>

                <div style="margin-top:24px; display:flex; gap:16px;">
                  <button id="btn-save" class="btn btn-primary" style="flex:1" onclick="Form.submit()">
                    <span class="material-symbols-rounded">save</span> บันทึกข้อมูล
                  </button>
                  <button id="btn-reset" class="btn btn-secondary" onclick="Form.reset()">ล้างค่า</button>
                </div>

              </div>
            </div>
          </div>
        </section>

        <!-- View: List -->
        <section id="view-list" class="view-section active">
          
          <!-- Summary Cards Widget -->
          <div class="summary-grid" id="summary-section" style="display:none;">
            <div class="stat-card">
              <span class="material-symbols-rounded stat-icon">receipt_long</span>
              <div class="stat-val" id="sum-total-orders">0</div>
              <div class="stat-label">ออเดอร์ทั้งหมด</div>
              <div class="stat-avg" id="sum-avg-orders">-</div>
            </div>
            <div class="stat-card">
              <span class="material-symbols-rounded stat-icon" style="color:var(--warning); background:var(--warning-bg)">inventory_2</span>
              <div class="stat-val" id="sum-total-items" style="color:var(--text-main)">0</div>
              <div class="stat-label">จำนวนชิ้นรวม</div>
              <div class="stat-avg" id="sum-avg-items">-</div>
            </div>
            <div class="product-summary-card" style="grid-column: 1 / -1;">
               <div style="font-weight:600; font-size:14px; margin-bottom:10px;">สรุปสินค้า</div>
               <div class="tag-cloud" id="sum-products-list"></div>
            </div>
          </div>

          <!-- Filter Bar -->
          <div class="filter-bar">
             <div class="search-wrapper">
               <span class="material-symbols-rounded search-icon">search</span>
               <input type="text" id="search-input" class="filter-input" placeholder="ค้นหาออเดอร์, ชื่อ, เบอร์..." onkeyup="List.handleSearch(this.value)">
             </div>
             
             <!-- Dynamic Input Group -->
             <div id="date-input-group" style="display:flex; align-items:center; gap:8px;">
                 <input type="date" id="filter-daily" class="filter-input" style="display:none;" onchange="List.filter()">
                 <input type="month" id="filter-monthly" class="filter-input" style="display:none;" onchange="List.filter()">
                 <select id="filter-yearly" class="filter-input" style="display:none; min-width:100px;" onchange="List.filter()"></select>
                 <div id="date-custom-wrapper" class="date-custom-group" style="display:none; align-items:center; gap:8px;">
                     <input type="date" id="filter-start" class="filter-input" onchange="List.filter()">
                     <span style="color:#aaa">-</span>
                     <input type="date" id="filter-end" class="filter-input" onchange="List.filter()">
                 </div>
             </div>

             <select id="filter-date" class="filter-input" style="min-width:140px;" onchange="List.handleDateChange()">
                <option value="all">ทุกช่วงเวลา</option>
                <option value="daily">รายวัน</option>
                <option value="monthly">รายเดือน</option>
                <option value="yearly">รายปี</option>
                <option value="custom">กำหนดช่วง...</option>
             </select>

             <select id="filter-set" class="filter-input" onchange="List.filter()">
                <option value="">ชุดทั้งหมด</option>
             </select>
             <select id="filter-courier" class="filter-input" onchange="List.filter()">
                <option value="">ขนส่งทั้งหมด</option>
             </select>
             
             <button class="btn btn-secondary" style="padding: 8px 12px; min-width: auto;" onclick="List.resetFilters()" title="ล้างตัวกรอง">
                <span class="material-symbols-rounded" style="font-size: 20px;">filter_alt_off</span>
             </button>
          </div>

          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
             <div style="font-size:14px; font-weight:500;">รายการล่าสุด <span style="color:var(--text-sub); font-weight:400;">(ทั้งหมด <span id="list-count">0</span> รายการ)</span></div>
             <button class="btn btn-sm btn-secondary" onclick="List.loadData(true)">
                <span class="material-symbols-rounded" style="font-size:16px;">refresh</span> รีเฟรช
             </button>
          </div>

          <div id="list-container"></div>
          
        </section>

      </div>
      
      <!-- Sticky Footer for Pagination -->
      <div id="pagination-footer" class="page-footer" style="display:none;">
          <div id="pagination-controls" class="pagination"></div>
      </div>

    </main>

    <!-- Mobile Bottom Nav -->
    <nav class="bottom-nav">
       <button class="b-nav-item" id="mob-form" onclick="App.nav('form')">
          <span class="material-symbols-rounded">add_circle</span>
          <span>บันทึก</span>
       </button>
       <button class="b-nav-item active" id="mob-list" onclick="App.nav('list')">
          <span class="material-symbols-rounded">dashboard</span>
          <span>รายการ</span>
       </button>
    </nav>
  </div>

  <!-- Modal -->
  <div id="confirm-modal" class="modal-backdrop">
    <div class="modal">
      <div style="width:60px; height:60px; background:#FEE2E2; color:#EF4444; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
        <span class="material-symbols-rounded" style="font-size:32px">delete</span>
      </div>
      <h3 style="font-size:20px; font-weight:600; margin-bottom:8px;">ยืนยันการลบ?</h3>
      <p style="color:var(--text-sub); font-size:15px; margin-bottom:24px;">
        คุณต้องการลบออเดอร์ <b id="modal-target" style="color:var(--text-main)"></b> ใช่หรือไม่?
      </p>
      <div style="display:flex; gap:12px;">
        <button class="btn btn-secondary" style="flex:1; padding:12px;" onclick="UI.closeModal()">ยกเลิก</button>
        <button id="btn-confirm-delete" class="btn btn-warning" style="flex:1; padding:12px; background:var(--danger); border:none;">ยืนยันลบ</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">
    <span class="material-symbols-rounded t-icon">check_circle</span>
    <span id="toast-msg">บันทึกสำเร็จ</span>
  </div>

  <script>
    /**
     * APP CORE & STATE
     */
    const App = {
      master: { products: [], couriers: [] },
      state: {
        isEditing: false,
        editingId: null,
        dataList: [],
        filteredList: [],
        page: 1,
        perPage: 10
      },
      cache: {
        save: (key, data) => { try { localStorage.setItem('OMP_' + key, JSON.stringify(data)); } catch(e){} },
        load: (key) => { try { const d = localStorage.getItem('OMP_' + key); return d ? JSON.parse(d) : null; } catch(e){ return null; } }
      },
      init: function() {
        const cachedMaster = this.cache.load('MASTER');
        if (cachedMaster) {
            this.master = cachedMaster;
            Form.initOptions();
        }

        const cachedOrders = this.cache.load('ORDERS');
        const hasCache = !!cachedOrders;
        if (cachedOrders) {
            this.state.dataList = cachedOrders;
            List.filter();
        } else {
             UI.showToast('กำลังโหลดข้อมูล...', 'info');
        }

        google.script.run.withSuccessHandler((res) => {
          if(res.success) {
            this.master = res.data;
            this.cache.save('MASTER', res.data);
            Form.initOptions();
          }
        }).getInitData();

        List.loadData(true, hasCache); 

        const today = new Date();
        document.getElementById('inp-date').valueAsDate = today;
        UI.el('filter-daily').valueAsDate = today;
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        UI.el('filter-monthly').value = `${yyyy}-${mm}`;
        UI.el('filter-start').valueAsDate = today;
        UI.el('filter-end').valueAsDate = today;
        
        const yearSel = UI.el('filter-yearly');
        yearSel.innerHTML = '';
        for(let y = yyyy + 1; y >= yyyy - 5; y--) {
            const opt = document.createElement('option');
            opt.value = y; opt.innerText = y; yearSel.appendChild(opt);
        }
        yearSel.value = yyyy;

        Form.addProductRow();
        Form.setupPhoneValidation();
      },
      nav: function(viewId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + viewId).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('menu-' + viewId).classList.add('active');
        document.querySelectorAll('.b-nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('mob-' + viewId).classList.add('active');
        document.getElementById('page-title').innerText = viewId === 'form' ? 'บันทึกออเดอร์' : 'รายการออเดอร์';
        
        const footer = document.getElementById('pagination-footer');
        if (viewId === 'list') {
             const totalItems = App.state.filteredList.length;
             const totalPages = Math.ceil(totalItems / App.state.perPage) || 1;
             footer.style.display = (totalPages > 1) ? 'flex' : 'none';
        } else {
             footer.style.display = 'none';
        }
      }
    };

    /** UI UTILITIES */
    const UI = {
      el: (id) => document.getElementById(id),
      showToast: (msg, type = 'success') => {
        const t = UI.el('toast');
        const txt = UI.el('toast-msg');
        const icon = t.querySelector('.t-icon');
        t.className = `toast show ${type}`;
        txt.innerText = msg;
        icon.innerText = type === 'error' ? 'error' : (type === 'info' ? 'info' : 'check_circle');
        setTimeout(() => t.classList.remove('show'), 3000);
      },
      showModal: (targetName, callback) => {
        UI.el('modal-target').innerText = targetName;
        UI.el('confirm-modal').classList.add('show');
        UI.el('btn-confirm-delete').onclick = () => { UI.closeModal(); callback(); };
      },
      closeModal: () => UI.el('confirm-modal').classList.remove('show'),
      formatPhoneDisplay: (val) => {
        if(!val) return '-';
        let clean = val.replace(/\D/g, '');
        if(clean.startsWith('66')) clean = '0' + clean.substring(2);
        if(clean.length === 10) return `${clean.substring(0,3)}-${clean.substring(3,6)}-${clean.substring(6,10)}`;
        return val;
      }
    };

    /** FORM CONTROLLER */
    const Form = {
      initOptions: () => {
        const sel = UI.el('inp-courier');
        const currentVal = sel.value;
        sel.innerHTML = '<option value="">เลือกขนส่ง...</option>';
        App.master.couriers.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c; opt.innerText = c;
          sel.appendChild(opt);
        });
        if(currentVal) sel.value = currentVal;
      },
      setupPhoneValidation: () => {
         const input = UI.el('inp-phone');
         const counter = UI.el('phone-counter');
         const msg = UI.el('msg-phone');
         input.addEventListener('input', (e) => {
             let val = e.target.value.replace(/\D/g, '');
             e.target.value = val;
             const len = val.length;
             counter.innerText = `${len}/10`;
             input.classList.remove('valid', 'error', 'warning');
             counter.classList.remove('valid', 'invalid', 'warning');
             msg.style.display = 'none';
             if(len === 0) { counter.style.color = '#ccc'; return; }
             if(val[0] !== '0') {
                 input.classList.add('error'); counter.classList.add('invalid');
                 msg.innerText = 'ต้องขึ้นต้นด้วย 0'; msg.style.display = 'block';
             } else if(len !== 10) {
                 input.classList.add('error'); counter.classList.add('invalid');
                 msg.innerText = len < 10 ? 'เบอร์ไม่ครบ 10 หลัก' : 'เบอร์เกิน 10 หลัก'; msg.style.display = 'block';
             } else {
                 input.classList.add('valid'); counter.classList.add('valid');
             }
         });
      },
      addProductRow: (name = '', qty = 1) => {
        const container = UI.el('product-container');
        const row = document.createElement('div');
        row.className = 'product-item';
        row.innerHTML = `
          <div class="search-select-wrapper" style="flex:1;">
            <input type="text" class="form-control prod-name" placeholder="ชื่อสินค้า..." style="padding-right: 32px"
              onfocus="Form.showAC(this)" oninput="Form.handleNameInput(this)" onblur="setTimeout(()=>Form.hideAC(this), 200)">
            <span class="material-symbols-rounded input-clear-btn" style="display:${name ? 'block' : 'none'}"
                  onmousedown="event.preventDefault(); Form.clearNameInput(this)">close</span>
            <div class="autocomplete-list"></div>
          </div>
          <input type="number" class="form-control prod-qty" min="1" style="width:80px; text-align:center;">
          <button type="button" class="btn-icon-soft" onclick="this.parentElement.remove()">
            <span class="material-symbols-rounded">close</span>
          </button>
        `;
        row.querySelector('.prod-name').value = name;
        row.querySelector('.prod-qty').value = qty;
        container.appendChild(row);
      },
      handleNameInput: (input) => {
         Form.filterAC(input);
         const btn = input.nextElementSibling;
         if (btn && btn.classList.contains('input-clear-btn')) {
             btn.style.display = input.value.length > 0 ? 'block' : 'none';
         }
      },
      clearNameInput: (btn) => {
         const input = btn.previousElementSibling;
         input.value = ''; input.focus();
         Form.handleNameInput(input);
      },
      showAC: (input) => {
        Form.filterAC(input);
        const list = input.parentElement.querySelector('.autocomplete-list');
        if(list) list.classList.add('show');
      },
      hideAC: (input) => { 
        const list = input.parentElement.querySelector('.autocomplete-list');
        if(list) list.classList.remove('show'); 
      },
      filterAC: (input) => {
        const list = input.parentElement.querySelector('.autocomplete-list');
        if(!list) return;
        const val = input.value.toLowerCase();
        list.innerHTML = '';
        const allInputs = document.querySelectorAll('.prod-name');
        const selectedElsewhere = Array.from(allInputs).filter(el => el !== input).map(el => el.value.trim());
        const keywords = val.split(/[\s\+\-\/]+/).filter(k => k.length > 0);
        const matches = App.master.products.filter(p => {
            const pLower = p.toLowerCase();
            const isMatch = keywords.every(k => pLower.includes(k));
            return isMatch && !selectedElsewhere.includes(p);
        });
        if (matches.length === 0) {
           list.innerHTML = `<div class="ac-item" style="color:#999; cursor:default;">${val ? 'ไม่พบสินค้า' : 'ไม่มีสินค้าให้เลือก'}</div>`; return;
        }
        matches.forEach(p => {
          const div = document.createElement('div');
          div.className = 'ac-item'; div.innerText = p;
          div.onmousedown = () => { input.value = p; list.classList.remove('show'); Form.handleNameInput(input); };
          list.appendChild(div);
        });
      },
      validate: () => {
        let valid = true;
        ['inp-date', 'inp-orderno'].forEach(id => {
          const el = UI.el(id);
          if(!el.value.trim()) { el.classList.add('error'); valid = false; } else { el.classList.remove('error'); }
        });
        const phoneEl = UI.el('inp-phone');
        const phoneVal = phoneEl.value.replace(/\D/g, '');
        const phoneErr = UI.el('msg-phone');
        if(phoneVal.length > 0) {
            if(!phoneVal.startsWith('0')) {
                phoneEl.classList.add('error'); phoneErr.innerText = "เบอร์ต้องขึ้นต้นด้วย 0"; phoneErr.style.display = 'block'; valid = false;
            } else if (phoneVal.length !== 10) {
                phoneEl.classList.add('error'); phoneErr.innerText = "เบอร์ไม่ครบ 10 หลัก"; phoneErr.style.display = 'block'; valid = false;
            } else { phoneErr.style.display = 'none'; phoneEl.classList.remove('error'); phoneEl.classList.add('valid'); }
        }
        if(document.querySelectorAll('.prod-name').length === 0) valid = false;
        return valid;
      },
      submit: () => {
        if(!Form.validate()) { UI.showToast('กรุณาตรวจสอบข้อมูล', 'error'); return; }
        const btn = UI.el('btn-save');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="material-symbols-rounded" style="animation:spin 1s linear infinite">sync</span> กำลังบันทึก...';
        btn.disabled = true;
        const items = [];
        document.querySelectorAll('.product-item').forEach(row => {
          const name = row.querySelector('.prod-name').value.trim();
          const qty = row.querySelector('.prod-qty').value;
          if(name) items.push({ name, qty });
        });
        if(items.length === 0) {
           UI.showToast('ต้องมีสินค้าอย่างน้อย 1 รายการ', 'error'); btn.innerHTML = originalText; btn.disabled = false; return;
        }
        const payload = {
          date: UI.el('inp-date').value, order_no: UI.el('inp-orderno').value, phone: UI.el('inp-phone').value,
          set_name: UI.el('inp-set').value, page_no: UI.el('inp-page').value, recipient_name: UI.el('inp-name').value,
          address: UI.el('inp-address').value, courier: UI.el('inp-courier').value, items: items
        };
        const handler = (res) => {
          btn.innerHTML = originalText; btn.disabled = false;
          if(res.success) { UI.showToast(res.message); Form.reset(); App.nav('list'); List.loadData(true); } else { UI.showToast(res.message, 'error'); }
        };
        if (App.state.isEditing) google.script.run.withSuccessHandler(handler).updateOrder(App.state.editingId, payload);
        else google.script.run.withSuccessHandler(handler).saveData(payload);
      },
      reset: () => {
        App.state.isEditing = false; App.state.editingId = null;
        UI.el('form-heading').innerText = "ข้อมูลออเดอร์";
        const btnSave = UI.el('btn-save');
        btnSave.innerHTML = '<span class="material-symbols-rounded">save</span> บันทึกข้อมูล';
        btnSave.classList.remove('btn-warning'); btnSave.classList.add('btn-primary');
        const btnReset = UI.el('btn-reset');
        btnReset.innerText = 'ล้างค่า'; btnReset.onclick = () => Form.reset();
        ['inp-orderno', 'inp-phone', 'inp-set', 'inp-page', 'inp-name', 'inp-address', 'inp-courier'].forEach(id => UI.el(id).value = '');
        UI.el('product-container').innerHTML = '';
        UI.el('inp-orderno').disabled = false;
        Form.addProductRow();
        UI.el('inp-date').valueAsDate = new Date();
        document.querySelectorAll('.form-control').forEach(e => e.classList.remove('error', 'valid', 'warning'));
        UI.el('phone-counter').innerText = "0/10";
        UI.el('phone-counter').classList.remove('valid', 'invalid', 'warning'); UI.el('phone-counter').style.color = '#ccc';
        UI.el('msg-phone').style.display = 'none';
      },
      cancelEdit: () => { Form.reset(); App.nav('list'); },
      loadEdit: (orderId) => {
        const order = App.state.dataList.find(o => o.no === orderId);
        if(!order) return;
        App.state.isEditing = true; App.state.editingId = orderId;
        UI.el('form-heading').innerText = `แก้ไขออเดอร์ ${orderId}`;
        const saveBtn = UI.el('btn-save');
        saveBtn.innerHTML = '<span class="material-symbols-rounded">edit</span> บันทึกการแก้ไข';
        saveBtn.classList.remove('btn-primary'); saveBtn.classList.add('btn-warning');
        const btnReset = UI.el('btn-reset');
        btnReset.innerText = 'ยกเลิกแก้ไข'; btnReset.onclick = () => Form.cancelEdit();
        const d = order.date.split('/');
        if(d.length === 3) UI.el('inp-date').value = `${d[2]}-${d[1]}-${d[0]}`;
        UI.el('inp-orderno').value = order.no; UI.el('inp-orderno').disabled = true;
        UI.el('inp-phone').value = order.tel.replace(/'/g, '');
        UI.el('inp-set').value = order.set; UI.el('inp-page').value = order.pg;
        UI.el('inp-name').value = order.nm; UI.el('inp-address').value = order.ad;
        UI.el('inp-courier').value = order.cur;
        UI.el('product-container').innerHTML = '';
        order.items.forEach(i => Form.addProductRow(i.name, i.qty));
        App.nav('form');
        UI.el('inp-phone').dispatchEvent(new Event('input'));
      }
    };

    /** LIST CONTROLLER */
    const List = {
      loadData: (force = false, isBackground = false) => {
        if(!force && App.state.dataList.length > 0) return;
        const container = UI.el('list-container');
        if (App.state.dataList.length === 0 && !isBackground) {
           container.innerHTML = Array(3).fill('<div class="skeleton"></div>').join('<br>');
        }
        google.script.run.withSuccessHandler((res) => {
          if(res.success) {
            App.state.dataList = res.data;
            App.cache.save('ORDERS', res.data);
            List.filter();
          } else if (!isBackground) {
               container.innerHTML = `<div style="text-align:center; padding:20px; color:var(--danger)">เกิดข้อผิดพลาดในการโหลด</div>`;
          }
        }).getOrderData();
      },
      updateFilterOptions: (items) => {
        const setSel = UI.el('filter-set');
        const curSel = UI.el('filter-courier');
        const currentSet = setSel.value;
        const currentCur = curSel.value;
        const sets = [...new Set(items.map(i => (i.set || '').trim()).filter(x => x))].sort();
        const couriers = [...new Set(items.map(i => (i.cur || '').trim()).filter(x => x))].sort();
        const setFrag = document.createDocumentFragment();
        const curFrag = document.createDocumentFragment();
        const defSet = document.createElement('option'); defSet.value = ""; defSet.innerText = "ชุดทั้งหมด"; setFrag.appendChild(defSet);
        const defCur = document.createElement('option'); defCur.value = ""; defCur.innerText = "ขนส่งทั้งหมด"; curFrag.appendChild(defCur);
        sets.forEach(s => { const o = document.createElement('option'); o.value = s; o.innerText = s; setFrag.appendChild(o); });
        couriers.forEach(c => { const o = document.createElement('option'); o.value = c; o.innerText = c; curFrag.appendChild(o); });
        setSel.innerHTML = ""; setSel.appendChild(setFrag);
        curSel.innerHTML = ""; curSel.appendChild(curFrag);
        if (sets.includes(currentSet)) setSel.value = currentSet;
        if (couriers.includes(currentCur)) curSel.value = currentCur;
      },
      handleDateChange: () => {
         const mode = UI.el('filter-date').value;
         UI.el('filter-daily').style.display = mode === 'daily' ? 'block' : 'none';
         UI.el('filter-monthly').style.display = mode === 'monthly' ? 'block' : 'none';
         UI.el('filter-yearly').style.display = mode === 'yearly' ? 'block' : 'none';
         UI.el('date-custom-wrapper').style.display = mode === 'custom' ? 'flex' : 'none';
         List.filter();
      },
      resetFilters: () => {
         UI.el('search-input').value = ''; UI.el('filter-date').value = 'all';
         const today = new Date();
         UI.el('filter-start').valueAsDate = today; UI.el('filter-end').valueAsDate = today;
         UI.el('filter-daily').valueAsDate = today;
         UI.el('filter-daily').style.display = 'none'; UI.el('filter-monthly').style.display = 'none';
         UI.el('filter-yearly').style.display = 'none'; UI.el('date-custom-wrapper').style.display = 'none';
         UI.el('filter-set').value = ""; UI.el('filter-courier').value = "";
         List.filter();
      },
      handleSearch: (() => {
        let timer;
        return (val) => { clearTimeout(timer); timer = setTimeout(() => List.filter(), 300); };
      })(),
      renderPagination: (totalPages) => {
         const container = UI.el('pagination-controls');
         const footer = UI.el('pagination-footer');
         container.innerHTML = '';
         if(totalPages <= 1) { footer.style.display = 'none'; return; }
         footer.style.display = 'flex';
         const createBtn = (label, page, isActive = false, isDisabled = false, icon = null) => {
             const btn = document.createElement('button');
             btn.className = `page-btn ${isActive ? 'active' : ''}`;
             if(icon) btn.innerHTML = `<span class="material-symbols-rounded" style="font-size:18px">${icon}</span>`;
             else btn.innerText = label;
             if(isDisabled) btn.disabled = true;
             else btn.onclick = () => { App.state.page = page; List.render(); };
             return btn;
         };
         container.appendChild(createBtn('Prev', App.state.page - 1, false, App.state.page === 1, 'chevron_left'));
         const maxVisible = 5; 
         let startPage, endPage;
         if (totalPages <= maxVisible) { startPage = 1; endPage = totalPages; } 
         else {
             const maxPagesBeforeCurrentPage = Math.floor(maxVisible / 2);
             const maxPagesAfterCurrentPage = Math.ceil(maxVisible / 2) - 1;
             if (App.state.page <= maxPagesBeforeCurrentPage + 1) { startPage = 1; endPage = maxVisible; } 
             else if (App.state.page + maxPagesAfterCurrentPage >= totalPages) { startPage = totalPages - maxVisible + 1; endPage = totalPages; } 
             else { startPage = App.state.page - maxPagesBeforeCurrentPage; endPage = App.state.page + maxPagesAfterCurrentPage; }
         }
         if (startPage > 1) {
             container.appendChild(createBtn('1', 1));
             if (startPage > 2) container.appendChild(Object.assign(document.createElement('span'), {className:'page-dots', innerText:'...'}));
         }
         for (let i = startPage; i <= endPage; i++) container.appendChild(createBtn(i, i, i === App.state.page));
         if (endPage < totalPages) {
             if (endPage < totalPages - 1) container.appendChild(Object.assign(document.createElement('span'), {className:'page-dots', innerText:'...'}));
             container.appendChild(createBtn(totalPages, totalPages));
         }
         container.appendChild(createBtn('Next', App.state.page + 1, false, App.state.page === totalPages, 'chevron_right'));
      },
      filter: () => {
        const search = UI.el('search-input').value.toLowerCase();
        const dateMode = UI.el('filter-date').value;
        let cStart = null, cEnd = null, cDateStr = null, cMonthStr = null, cYearStr = null;
        if(dateMode === 'daily') cDateStr = UI.el('filter-daily').value; 
        else if (dateMode === 'monthly') cMonthStr = UI.el('filter-monthly').value;
        else if (dateMode === 'yearly') cYearStr = UI.el('filter-yearly').value;
        else if(dateMode === 'custom') {
           const sVal = UI.el('filter-start').value; const eVal = UI.el('filter-end').value;
           if(sVal) cStart = new Date(sVal); if(eVal) cEnd = new Date(eVal);
           if(cStart) cStart.setHours(0,0,0,0); if(cEnd) cEnd.setHours(23,59,59,999);
        }
        const itemsInDateRange = App.state.dataList.filter(item => {
           if (dateMode === 'all') return true;
           const [d, m, y] = item.date.split('/').map(Number);
           if(dateMode === 'daily') return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}` === cDateStr;
           if(dateMode === 'monthly') return `${y}-${String(m).padStart(2,'0')}` === cMonthStr;
           if(dateMode === 'yearly') return String(y) === cYearStr;
           if(dateMode === 'custom') {
              const itemDate = new Date(y, m-1, d); itemDate.setHours(0,0,0,0);
              if(cStart && itemDate < cStart) return false;
              if(cEnd && itemDate > cEnd) return false;
              return true;
           }
           return true;
        });
        List.updateFilterOptions(itemsInDateRange);
        const filterSet = UI.el('filter-set').value;
        const filterCur = UI.el('filter-courier').value;
        App.state.filteredList = itemsInDateRange.filter(item => {
          if(filterSet && (item.set || '').toString().trim() !== filterSet) return false;
          if(filterCur && (item.cur || '').toString().trim() !== filterCur) return false;
          if (search) {
             const str = `${item.no} ${item.nm} ${item.tel}`.toLowerCase();
             if(!str.includes(search)) return false;
          }
          return true;
        });
        List.renderSummary();
        UI.el('list-count').innerText = App.state.filteredList.length;
        App.state.page = 1;
        List.render();
      },
      renderSummary: () => {
         const list = App.state.filteredList;
         const sumWrap = UI.el('summary-section');
         sumWrap.style.display = 'grid';
         const dateMode = UI.el('filter-date').value;
         const showMonthlyAvg = (dateMode !== 'monthly' && dateMode !== 'daily');
         if(list.length === 0) {
            UI.el('sum-total-orders').innerText = '0'; UI.el('sum-total-items').innerText = '0';
            UI.el('sum-avg-orders').innerText = '-'; UI.el('sum-avg-items').innerText = '-';
            UI.el('sum-products-list').innerHTML = '<div style="color:#9ca3af; font-size:12px;">ไม่มีข้อมูล</div>'; return;
         }
         const timestamps = list.map(o => { const p = o.date.split('/'); return new Date(p[2], p[1]-1, p[0]).getTime(); }).filter(t => !isNaN(t));
         let daysSpan = 1;
         if (timestamps.length > 0) {
             const minTime = Math.min(...timestamps); const maxTime = Math.max(...timestamps);
             daysSpan = Math.floor((maxTime - minTime) / (1000 * 60 * 60 * 24)) + 1;
         }
         const totalOrders = list.length;
         UI.el('sum-total-orders').innerText = totalOrders;
         const avgOrdDay = Math.round(totalOrders / daysSpan);
         let ordHtml = `<div class="stat-row"><span>เฉลี่ย/วัน</span> <b>${avgOrdDay.toLocaleString()}</b></div>`;
         if (showMonthlyAvg) {
            const avgOrdMonth = Math.round((totalOrders / daysSpan) * 30);
            ordHtml += `<div class="stat-row"><span>เฉลี่ย/เดือน</span> <b>${avgOrdMonth.toLocaleString()}</b></div>`;
         }
         UI.el('sum-avg-orders').innerHTML = ordHtml;
         let totalQty = 0; const prodCounts = {};
         list.forEach(o => o.items.forEach(i => { const q = parseInt(i.qty)||0; totalQty+=q; prodCounts[i.name]=(prodCounts[i.name]||0)+q; }));
         UI.el('sum-total-items').innerText = totalQty;
         const avgItmDay = Math.round(totalQty / daysSpan);
         let itmHtml = `<div class="stat-row"><span>เฉลี่ย/วัน</span> <b>${avgItmDay.toLocaleString()}</b></div>`;
         if (showMonthlyAvg) {
             const avgItmMonth = Math.round((totalQty / daysSpan) * 30);
             itmHtml += `<div class="stat-row"><span>เฉลี่ย/เดือน</span> <b>${avgItmMonth.toLocaleString()}</b></div>`;
         }
         UI.el('sum-avg-items').innerHTML = itmHtml;
         const right = UI.el('sum-products-list');
         const frag = document.createDocumentFragment();
         const sortedKeys = Object.keys(prodCounts).sort((a, b) => {
             const idxA = App.master.products.indexOf(a); const idxB = App.master.products.indexOf(b);
             if (idxA !== -1 && idxB !== -1) return idxA - idxB;
             return idxA !== -1 ? -1 : (idxB !== -1 ? 1 : a.localeCompare(b));
         });
         sortedKeys.forEach(p => {
             const count = prodCounts[p];
             const avgP_Day = Math.round(count / daysSpan);
             const avgP_Month = Math.round((count / daysSpan) * 30);
             let meta = `(Ø ${avgP_Day}/ว`;
             if (showMonthlyAvg) meta += `, ${avgP_Month}/ด`;
             meta += `)`;
             const div = document.createElement('div');
             div.className = 'tag-item';
             div.innerHTML = `${p} <b>${count}</b> <span style="color:#9CA3AF; font-size:10px; margin-left:4px;">${meta}</span>`;
             frag.appendChild(div);
         });
         right.innerHTML = ''; right.appendChild(frag);
      },
      render: () => {
        const container = UI.el('list-container');
        const totalItems = App.state.filteredList.length;
        const totalPages = Math.ceil(totalItems / App.state.perPage) || 1;
        if (App.state.page > totalPages) App.state.page = totalPages;
        if (App.state.page < 1) App.state.page = 1;
        const start = (App.state.page - 1) * App.state.perPage;
        const end = start + App.state.perPage;
        const items = App.state.filteredList.slice(start, end);
        if (totalItems === 0) {
          container.innerHTML = `<div style="text-align:center; padding:60px 20px; opacity:0.6;"><span class="material-symbols-rounded" style="font-size:64px; color:var(--text-sub)">inbox_customize</span><p style="margin-top:10px">ไม่พบรายการออเดอร์</p></div>`;
          UI.el('pagination-footer').style.display = 'none'; return;
        }
        let html = items.map(o => {
          const productBadges = o.items.map(i => `<span class="prod-badge">${i.name} (${i.qty})</span>`).join('');
          return `
            <div class="order-item">
              <div class="oi-header"><div class="oi-id"><span class="material-symbols-rounded" style="font-size:18px;">receipt_long</span>${o.no}</div><div class="oi-meta">${o.date}</div></div>
              <div class="oi-body">
                <div class="oi-field"><label>วันที่</label><span>${o.date}</span></div>
                <div class="oi-field"><label>ผู้รับ</label><span>${o.nm}</span></div>
                <div class="oi-field"><label>เบอร์โทร</label><span>${UI.formatPhoneDisplay(o.tel)}</span></div>
                <div class="oi-field"><label>ชุด/ใบ</label><span>${o.set || '-'} / ${o.pg || '-'}</span></div>
                <div class="oi-field"><label>ขนส่ง</label><span style="color:var(--primary)">${o.cur || 'ไม่ระบุ'}</span></div>
                <div class="oi-field" style="grid-column: 1/-1"><label>ที่อยู่</label><span>${o.ad || '-'}</span></div>
              </div>
              <div class="oi-products">${productBadges}</div>
              <div class="oi-actions">
                <button class="btn btn-sm btn-secondary" onclick="Form.loadEdit('${o.no}')">แก้ไข</button>
                <button class="btn btn-sm" style="background:var(--danger-bg); color:var(--danger);" onclick="List.confirmDelete('${o.no}')">ลบ</button>
              </div>
            </div>`;
        }).join('');
        container.innerHTML = html;
        List.renderPagination(totalPages);
      },
      confirmDelete: (id) => {
         UI.showModal(id, () => {
            UI.showToast('กำลังลบข้อมูล...', 'info');
            google.script.run.withSuccessHandler((res) => {
              if(res.success) {
                UI.showToast(res.message);
                App.state.dataList = App.state.dataList.filter(o => o.no !== id);
                App.cache.save('ORDERS', App.state.dataList); List.filter();
              } else { UI.showToast(res.message, 'error'); }
            }).deleteOrder(id);
         });
      }
    };
    window.onload = () => App.init();
  </script>
</body>
</html>
