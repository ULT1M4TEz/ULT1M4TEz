/**
 * ============================================================
 * ORDER MANAGEMENT PRO - BACKEND (STANDARD EDITION)
 * Regex-based extraction only. No AI dependency.
 * ============================================================
 */

const CONFIG = {
  SHEET_ORDERS: "Orders",
  SHEET_PRODUCTS: "Products",
  SHEET_COURIERS: "Courier"
};

function doGet() {
  return HtmlService.createHtmlOutputFromFile('Index')
      .setTitle('Order Management Pro')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
      .addMetaTag('viewport', 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0');
}

// --- Standard Response Helper ---
function createResponse(success, data = null, message = "") {
  return { success, data, message };
}

// --- API: Get Master Data ---
function getInitData() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const getList = (sheetName, col) => {
      const sheet = ss.getSheetByName(sheetName);
      if (!sheet) return [];
      const lastRow = sheet.getLastRow();
      if (lastRow < 2) return [];
      return sheet.getRange(`${col}2:${col}${lastRow}`).getValues()
        .flat()
        .filter(item => item && item.toString().trim() !== "");
    };
    return createResponse(true, {
      products: getList(CONFIG.SHEET_PRODUCTS, "B"),
      couriers: getList(CONFIG.SHEET_COURIERS, "A")
    });
  } catch (e) {
    return createResponse(false, null, e.message);
  }
}

// --- Utility: Formats ---
function formatDateThai(dateStr) {
  if (!dateStr) return "";
  dateStr = dateStr.trim().replace(/'/g, '');

  // Case 1: Already DD/MM/YYYY -> Keep it
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
      return `'${dateStr}`;
  }

  // Case 2: Input is YYYY-MM-DD -> Convert to DD/MM/YYYY
  const isoParts = dateStr.split('-');
  if (isoParts.length === 3) {
      if (isoParts[0].length === 4) { // YYYY-MM-DD
           return `'${isoParts[2]}/${isoParts[1]}/${isoParts[0]}`;
      } else if (isoParts[2].length === 4) { // DD-MM-YYYY
           return `'${isoParts[0]}/${isoParts[1]}/${isoParts[2]}`;
      }
  }
  return "'" + dateStr;
}

function formatPhoneForSheet(p) {
  let str = (p || "").toString().trim().replace(/-|\s/g, "");
  if (str === "") return "";
  if (str.startsWith("66")) str = "0" + str.substring(2);
  return "'" + str; 
}

// --- API: Save Data ---
function saveData(data) {
  return saveBatchData({ orders: [data] });
}

// --- API: Save Batch Data ---
function saveBatchData(payload) {
  const lock = LockService.getScriptLock();
  if (!lock.tryLock(20000)) return createResponse(false, null, "ระบบกำลังยุ่ง กรุณาลองใหม่");

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName(CONFIG.SHEET_ORDERS);
    if (!sheet) {
        sheet = ss.insertSheet(CONFIG.SHEET_ORDERS);
        sheet.appendRow(["Date", "Order No", "Set", "Page", "Recipient", "Address", "Phone", "Product", "Qty", "Courier"]);
    }
    
    const allRows = [];
    payload.orders.forEach(data => {
      const phone = formatPhoneForSheet(data.phone);
      const dateStr = formatDateThai(data.date);
      data.items.forEach(item => {
        allRows.push([
          dateStr, data.order_no.toString(), data.set_name, data.page_no,
          data.recipient_name, data.address, phone, item.name, item.qty, data.courier
        ]);
      });
    });

    if (allRows.length > 0) {
      sheet.getRange(sheet.getLastRow() + 1, 1, allRows.length, allRows[0].length).setValues(allRows);
    }
    return createResponse(true, null, `บันทึกสำเร็จ ${payload.orders.length} ออเดอร์`);
  } catch (e) {
    return createResponse(false, null, "Error: " + e.message);
  } finally {
    lock.releaseLock();
  }
}

// --- API: Update Order ---
function updateOrder(oldNo, newData) {
  const lock = LockService.getScriptLock();
  if (!lock.tryLock(10000)) return createResponse(false, null, "ระบบกำลังยุ่ง");

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(CONFIG.SHEET_ORDERS);
    const dataRange = sheet.getDataRange();
    const values = dataRange.getValues(); 
    
    const rowsToDelete = [];
    for (let i = values.length - 1; i >= 1; i--) { 
      if (values[i][1].toString() === oldNo.toString()) rowsToDelete.push(i + 1);
    }

    if (rowsToDelete.length === 0) return createResponse(false, null, "ไม่พบข้อมูลเดิม");

    rowsToDelete.forEach(rowIndex => sheet.deleteRow(rowIndex));

    const phone = formatPhoneForSheet(newData.phone);
    const dateStr = formatDateThai(newData.date);
    const newRows = newData.items.map(item => [
      dateStr, newData.order_no.toString(), newData.set_name, newData.page_no,
      newData.recipient_name, newData.address, phone, item.name, item.qty, newData.courier
    ]);

    const insertPos = rowsToDelete[rowsToDelete.length - 1]; 
    if (newRows.length > 0) {
      sheet.insertRowsBefore(insertPos, newRows.length);
      sheet.getRange(insertPos, 1, newRows.length, newRows[0].length).setValues(newRows);
    }
    return createResponse(true, null, "แก้ไขข้อมูลเรียบร้อย");
  } catch (e) {
    return createResponse(false, null, "Error: " + e.message);
  } finally {
    lock.releaseLock();
  }
}

// --- API: Delete Order ---
function deleteOrder(no) {
  const lock = LockService.getScriptLock();
  if (!lock.tryLock(10000)) return createResponse(false, null, "ระบบยุ่ง");
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(CONFIG.SHEET_ORDERS);
    const data = sheet.getDataRange().getValues();
    let deletedCount = 0;
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][1].toString() === no.toString()) { 
        sheet.deleteRow(i + 1); deletedCount++;
      }
    }
    if (deletedCount === 0) return createResponse(false, null, "ไม่พบข้อมูล");
    return createResponse(true, null, `ลบข้อมูลเรียบร้อย (${deletedCount} รายการ)`);
  } catch (e) {
    return createResponse(false, null, "Error: " + e.message);
  } finally {
    lock.releaseLock();
  }
}

// --- API: Get Orders Data ---
function getOrderData() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(CONFIG.SHEET_ORDERS);
    if (!sheet) return createResponse(true, []);
    const rows = sheet.getDataRange().getDisplayValues(); 
    if (rows.length <= 1) return createResponse(true, []);

    const grouped = {};
    for (let i = 1; i < rows.length; i++) {
      const r = rows[i];
      if (r.length < 2) continue;
      const id = r[1];
      if (!id) continue;
      if (!grouped[id]) {
        grouped[id] = { date: r[0], no: id, set: r[2], pg: r[3], nm: r[4], ad: r[5], tel: r[6], items: [], cur: r[9] };
      }
      if (r[7]) grouped[id].items.push({ name: r[7], qty: r[8] });
    }
    return createResponse(true, Object.values(grouped).reverse());
  } catch (e) {
    return createResponse(false, [], e.message);
  }
}

// --- API: Process PDF with Standard Logic (Robust Regex) ---
function processWithStandard(pdfPages) {
  if (!pdfPages || pdfPages.length === 0) return createResponse(false, null, "ไม่มีข้อมูล PDF");

  const results = [];

  try {
    pdfPages.forEach(p => {
      const text = p.text;
      
      // 1. Page Number
      const pageNo = p.pageIndex;

      // 2. Order No
      let orderNo = "";
      const orderMatch = text.match(/Shopee Order No\.?\s*([A-Z0-9]+)/i);
      if (orderMatch) orderNo = orderMatch[1];

      // 3. Date (Search for pattern DD-MM-YYYY)
      let date = "";
      const datePattern = text.match(/(\d{1,2})[-/](\d{1,2})[-/](\d{4})/);
      if (datePattern) {
          // Convert to YYYY-MM-DD for Frontend Input
          date = `${datePattern[3]}-${datePattern[2]}-${datePattern[1]}`;
      }

      // 4. Phone (Global Search for 66xxxxxxxxx or 0xxxxxxxxx)
      let phone = "";
      const phoneCandidates = text.match(/(?:66|0)\d{1}[-\s]*\d{3}[-\s]*\d{4,5}/g);
      if (phoneCandidates) {
         const cleanCandidates = phoneCandidates.map(ph => ph.replace(/\D/g, ''));
         const bestPhone = cleanCandidates.find(ph => ph.length >= 9 && (ph.startsWith('66') || ph.startsWith('06') || ph.startsWith('08') || ph.startsWith('09')));
         if (bestPhone) {
             phone = bestPhone;
             if (phone.startsWith('66')) phone = '0' + phone.substring(2);
         }
      }

      // 5. Recipient Name & Address
      let recipientName = "";
      let address = "";

      const toMarker = "ผู้รับ (TO)";
      const toIndex = text.indexOf(toMarker);

      if (toIndex !== -1) {
          // Find end of block
          let endIndices = [
              text.indexOf("Shopee Order No", toIndex),
              text.indexOf("Phone", toIndex),
              text.indexOf("PICKUP DATE", toIndex),
              text.indexOf("SHIP BY DATE", toIndex)
          ].filter(i => i !== -1);

          const endIndex = endIndices.length > 0 ? Math.min(...endIndices) : text.length;
          let recipientBlock = text.substring(toIndex + toMarker.length, endIndex).trim();

          // Remove phone if stuck in block
          if (phone) {
             recipientBlock = recipientBlock.replace(new RegExp(phone.replace(/^0/, '66'), 'g'), '');
             recipientBlock = recipientBlock.replace(new RegExp(phone, 'g'), '');
          }

          // Split Name vs Address
          // Strategy: Name is before first address keyword
          const addressMarker = recipientBlock.match(/(?:เลขที่|หมู่|ซอย|ถนน|ต\.|อ\.|จ\.|ตำบล|อำเภอ|จังหวัด|\d+\/)/);
          if (addressMarker) {
              const splitIdx = addressMarker.index;
              recipientName = recipientBlock.substring(0, splitIdx).trim();
              address = recipientBlock.substring(splitIdx).trim();
          } else {
              // Fallback
              recipientName = ""; 
              address = recipientBlock;
          }
      }

      // Clean Text Artifacts
      const clean = (t) => {
         if(!t) return "";
         let c = t.normalize('NFKC');
         c = c.replace(/[\u200B-\u200D\uFEFF]/g, '');
         c = c.replace(/\u0E4D\u0E32/g, '\u0E33'); // Fix Sara Am
         return c.trim();
      };

      results.push({
          page_no: pageNo,
          date: date,
          order_no: orderNo,
          recipient_name: clean(recipientName),
          address: clean(address),
          phone: phone,
          items: [{name: "", qty: 1}]
      });
    });

    return createResponse(true, results, "Success");

  } catch (error) {
    return createResponse(false, null, "Error: " + error.message);
  }
}
